<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Avyav Chess</title>

<!-- Orbitron for headings -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- chessboard.js & chess.js from CDNs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" integrity="sha512-+s8oV0K6c+g9k3q6e5p4oX2F3Qm5x3qg1j2d5bq2d7JnQxw2KZ8iKZz3Y2bE0q2Jk1TgVQ9q8QZ7kYz2v3XQg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js" integrity="sha512-f3p1W6Qe+4k7h4zXZbqS6wQ2e5Jx7m3qQK6y2u7m3X2Vt2Jw8V9k2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js" integrity="sha512-3m2Zz/..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
  /* ===== your original site styles (kept intact) ===== */
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Courier New', monospace;
    background: linear-gradient(to bottom right, #000428, #004e92);
    color: cyan;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #intro-container, #home-container, .content-page { display:none; justify-content:center; align-items:center; flex-direction:column; text-align:center; height:100vh; }

  #animation { font-size: 3rem; font-weight: bold; animation: fadeIn 2s ease forwards; }
  @keyframes fadeIn { from { opacity:0; transform:scale(0.8) } to { opacity:1; transform:scale(1) } }

  #intro-text { font-size:1.2rem; margin-top:2rem; width:80%; max-width:700px; white-space:pre-wrap; text-align:center; }

  #get-started {
    margin-top:2rem; padding:12px 30px; font-size:1rem; border:2px solid cyan; color:cyan; background:transparent; border-radius:10px; cursor:pointer; transition:0.3s; display:none;
  }
  #get-started:hover { background-color:cyan; color:#000428; }

  #dragon-image { margin-top:1.5rem; width:180px; opacity:0; transition: opacity 1s ease; }
  @keyframes dragonEnlargeFade { 0%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:1}100%{transform:scale(2);opacity:0} }

  footer {
    position:fixed; bottom:10px; left:0; right:0; text-align:center; color:cyan; font-size:1rem; display:none;
  }
  .youtube-container { display:inline-flex; align-items:center; gap:10px; }
  .youtube-logo { width:40px; height:30px; background-color:red; border-radius:8px; display:flex; justify-content:center; align-items:center; box-shadow:0 0 20px red; cursor:pointer; transition:transform .2s; }
  .youtube-logo:hover { transform:scale(1.1); }
  .youtube-logo::before { content:''; border-style:solid; border-width:8px 0 8px 14px; border-color:transparent transparent transparent white; }

  #home-container { display:none; position:relative; width:100vw; height:100vh; overflow:hidden; }
  #horse-image { position:absolute; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-2; }

  #home-buttons { display:flex; flex-direction:column; align-items:center; gap:1.2rem; position:relative; z-index:2; }
  .home-btn { padding:15px 35px; border:2px solid cyan; color:cyan; background:#000000; font-size:1.1rem; border-radius:10px; cursor:pointer; transition:0.3s; }
  .home-btn:hover { background-color:cyan; color:#000428; }

  .home-icon {
    position:absolute; top:20px; right:25px; width:40px; height:40px; background:cyan;
    mask: url('https://cdn-icons-png.flaticon.com/512/25/25694.png') no-repeat center; mask-size:contain;
    -webkit-mask: url('https://cdn-icons-png.flaticon.com/512/25/25694.png') no-repeat center; -webkit-mask-size:contain;
    cursor:pointer; z-index:2;
  }

  .sidebar-widget {
    position:absolute; left:15px; top:50%; transform:translateY(-50%); width:60px; height:300px; background:rgba(0,0,0,0.6);
    border:1px solid cyan; border-radius:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:10px; z-index:3;
  }
  .widget-btn { background:transparent; border:2px solid cyan; color:cyan; font-family:'Orbitron',sans-serif; font-size:1.1rem; width:40px; height:40px; border-radius:5px; cursor:pointer; transition:0.3s; }
  .widget-btn:hover { background-color:cyan; color:#000428; transform:scale(1.1); }

  .content-page { display:none; justify-content:center; align-items:center; flex-direction:column; height:100vh; background-color:black; color:cyan; text-align:center; font-size:1.5rem; }
  .content-page .home-icon { position:absolute; top:20px; right:25px; }

  @media (max-width:600px) {
    #animation { font-size:2.3rem; }
    #intro-text { font-size:1rem; }
    .home-btn { font-size:1rem; padding:12px 28px; }
  }

  /* ===== Bot page specific layout: image + board + move list side-by-side ===== */
  #bot-top {
    display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:14px;
  }
  #bot-top img { width:200px; max-width:70%; border:2px solid cyan; border-radius:12px; box-shadow:0 0 25px cyan; }

  #bot-main {
    display:flex; gap:20px; align-items:flex-start; justify-content:center; width:90%; max-width:1100px;
    margin-inline:auto; z-index:2;
  }

  /* chessboard container */
  #board-wrapper { background:transparent; padding:8px; border-radius:10px; }
  #myBoard { width:420px; max-width:60vw; }

  /* move list */
  #moves { width:260px; max-width:35vw; background:rgba(0,0,0,0.25); border:1px solid rgba(0,255,255,0.12); border-radius:10px; padding:10px; color:cyan; font-family:Arial, sans-serif; overflow:auto; height:420px; }
  #moves h3 { font-family:'Orbitron',sans-serif; margin-bottom:8px; color:cyan; font-size:1.05rem; }
  #moves ol { margin-left:16px; color:#dff; }

  .control-row { margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; }
  .btn { padding:8px 12px; border-radius:8px; border:2px solid cyan; background:transparent; color:cyan; cursor:pointer; font-weight:600; }
  .btn:hover { background:cyan; color:#000428; }

  /* result banner */
  #resultBanner { margin-top:12px; font-family:'Orbitron',sans-serif; color:yellow; display:none; }
</style>
</head>
<body>

<!-- ===== intro & homepage (left intact) ===== -->
<div id="animation">Avyav Chess</div>

<div id="intro-container">
  <div id="intro-text"></div>
  <button id="get-started">Enter Avyav Chess</button>
  <img id="dragon-image" src="dragon.png" alt="Dragon">
</div>

<div id="home-container">
  <img id="horse-image" src="horse.jpg" alt="Horse Background">
  <div class="sidebar-widget">
    <button class="widget-btn" onclick="openPage('korus')">K</button>
    <button class="widget-btn" onclick="openPage('o')">O</button>
    <button class="widget-btn" onclick="openPage('r')">R</button>
    <button class="widget-btn" onclick="openPage('u')">U</button>
    <button class="widget-btn" onclick="openPage('s')">S</button>
  </div>

  <div class="home-icon" id="home-icon"></div>

  <div id="home-buttons">
    <button class="home-btn" onclick="openPage('bot')">Play Chess with Bot</button>
    <button class="home-btn" onclick="openPage('learn')">Learn Chess</button>
    <button class="home-btn" onclick="openPage('videos')">Videos</button>
    <button class="home-btn" onclick="openPage('contact')">Contact Us for Feedback</button>
  </div>
</div>

<!-- ===== bot page: image + text + board + moves ===== -->
<div id="bot-page" class="content-page">
  <div class="home-icon" onclick="goHome()"></div>

  <div id="bot-top">
    <img src="avyavbot.png" alt="Avyav Bot">
    <div style="font-family:'Orbitron',sans-serif;color:cyan;">Avyav Bot - Rating : 4000 , Coming Soon</div>
  </div>

  <div id="bot-main">
    <div id="board-wrapper">
      <div id="myBoard"></div>

      <div class="control-row" style="justify-content:center;">
        <button id="startBtn" class="btn">Start Game</button>
        <button id="resignBtn" class="btn" style="display:none;">Resign</button>
        <div id="resultBanner"></div>
      </div>
    </div>

    <div id="moves">
      <h3>Move History</h3>
      <ol id="moveList"></ol>
    </div>
  </div>
</div>

<!-- other pages kept intact -->
<div id="korus-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>Website developed by Korus</h2></div>
<div id="o-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>O - Contents Coming Soon...</h2></div>
<div id="r-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>R - Contents Coming Soon...</h2></div>
<div id="u-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>U - Contents Coming Soon...</h2></div>
<div id="s-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>S - Contents Coming Soon...</h2></div>
<div id="learn-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>Contents Coming Soon...</h2></div>
<div id="videos-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>Contents Coming Soon...</h2></div>
<div id="contact-page" class="content-page"><div class="home-icon" onclick="goHome()"></div><h2>Contents Coming Soon...</h2></div>

<footer id="footer">
  <div class="youtube-container">
    <span>Subscribe to my YouTube Channel</span>
    <div class="youtube-logo" onclick="window.open('https://www.youtube.com/@AvyavChessYT','_blank')"></div>
  </div>
</footer>

<audio id="typingSound" src="typingsound.mp3"></audio>

<!-- ===== JS: site nav + chess integration ===== -->
<script>
/* ===== preserve your intro/navigation logic exactly as before ===== */
const animation = document.getElementById('animation');
const introContainer = document.getElementById('intro-container');
const introText = document.getElementById('intro-text');
const getStarted = document.getElementById('get-started');
const dragon = document.getElementById('dragon-image');
const footer = document.getElementById('footer');
const typingSound = document.getElementById('typingSound');

const fullText = "Hi, I am Avyav Namdev, welcome to my chess website. I am an advanced player with rating higher than 2100 in chess.com, I created this website for the love of chess.";

setTimeout(() => {
  animation.style.display = "none";
  introContainer.style.display = "flex";
  typeText();
}, 2500);

let i = 0;
function typeText() {
  if (i < fullText.length) {
    introText.textContent += fullText.charAt(i);
    if (typingSound.paused) typingSound.play();
    i++;
    setTimeout(typeText, 50);
  } else {
    typingSound.pause();
    typingSound.currentTime = 0;
    getStarted.style.display = "inline-block";
    setTimeout(() => {
      dragon.style.opacity = "1";
      footer.style.display = "block";
    }, 1000);
  }
}

getStarted.addEventListener('click', () => {
  dragon.style.animation = "dragonEnlargeFade 1.5s forwards";
  setTimeout(() => {
    introContainer.style.display = "none";
    document.getElementById('home-container').style.display = "flex";
  }, 1500);
});

function openPage(page) {
  document.getElementById('home-container').style.display = "none";
  document.querySelectorAll('.content-page').forEach(p => p.style.display = "none");
  const el = document.getElementById(`${page}-page`);
  if (el) el.style.display = "flex";
}
function goHome() {
  document.querySelectorAll('.content-page').forEach(p => p.style.display = "none");
  document.getElementById('home-container').style.display = "flex";
}
document.getElementById('home-icon').addEventListener('click', goHome);

/* ===== Chess integration starts here =====
   - chessboard.js is used for UI
   - chess.js used for legal moves & PGN
   - On every user move, we try chess-api.com. If it fails, fallback to a simple legal move selection. 
   - We keep the move list in sync.
   NOTE: chess-api.com documents REST Stockfish endpoints — we'll attempt calls and gracefully fallback.
   Source: chess-api.com documentation. :contentReference[oaicite:1]{index=1}
*/

let board = null;
let game = null; // chess.js instance
let playerIsWhite = true;
let engineThinking = false;
const moveListEl = document.getElementById('moveList');
const startBtn = document.getElementById('startBtn');
const resignBtn = document.getElementById('resignBtn');
const resultBanner = document.getElementById('resultBanner');

function makeMoveOnBoard(from, to, promotion) {
  // update chess.js and board
  const move = game.move({ from, to, promotion });
  if (move === null) return false;
  board.position(game.fen());
  renderMoveList();
  return move;
}

function renderMoveList() {
  moveListEl.innerHTML = '';
  const history = game.history({ verbose: true });
  // make pairs
  for (let i = 0, moveNo = 1; i < history.length; i += 2, moveNo++) {
    const white = history[i] ? history[i].san : '';
    const black = history[i + 1] ? history[i + 1].san : '';
    const li = document.createElement('li');
    li.style.marginBottom = '6px';
    li.innerHTML = `<strong>${moveNo}.</strong> ${white} ${black ? '&nbsp;&nbsp;' + black : ''}`;
    moveListEl.appendChild(li);
  }
  // scroll to bottom
  moveListEl.scrollTop = moveListEl.scrollHeight;
}

function onDragStart(source, piece, position, orientation) {
  if (engineThinking) return false;
  // prevent dragging opponent's pieces
  if (!game) return false;
  const turn = game.turn(); // 'w' or 'b'
  if ((turn === 'w' && piece.search(/^b/) !== -1) || (turn === 'b' && piece.search(/^w/) !== -1)) {
    return false;
  }
}

function onDrop(source, target) {
  // attempt to make the move
  const promotion = 'q'; // auto-promote to queen
  const move = makeMoveOnBoard(source, target, promotion);
  if (!move) {
    board.position(game.fen()); // illegal move, snapback
    return;
  }

  // check for game end after player's move
  if (game.game_over()) {
    finishGame();
    return;
  }

  // engine to reply
  engineMove();
}

function onSnapEnd() {
  board.position(game.fen());
}

/* ==== Engine interaction: try chess-api.com endpoints, fallback to local move ==== */

async function getEngineMoveFromAPI(fen) {
  // We'll attempt a couple of common endpoints/params that chess-api sites use.
  // If none succeed, return null to trigger fallback.
  const endpoints = [
    // Many public Stockfish REST APIs accept {fen} and return best move in JSON.
    // These two are commonly mirrored by different providers (we try both).
    { url: `https://chess-api.com/api/v1/move`, method: 'POST', body: { fen } }, // attempt 1
    { url: `https://chess-api.com/api/v1/best`, method: 'POST', body: { fen } }, // attempt 2
    { url: `https://chess-api.com/api/v1/stockfish`, method: 'POST', body: { fen } }, // attempt 3
    // RapidAPI or other proxies might have different endpoints; tries below might also work depending on provider config:
    { url: `https://chess-api.com/engine`, method: 'POST', body: { fen } }
  ];

  for (const ep of endpoints) {
    try {
      const r = await fetch(ep.url, {
        method: ep.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ep.body),
      });
      if (!r.ok) continue;
      const data = await r.json();
      /* try to read possible response shapes:
         - { move: "e7e5" }
         - { best: "e7e5" }
         - { bestmove: "e7e5" }
         - { pv: ["e7e5", ...] }
      */
      if (typeof data === 'object') {
        if (data.move) return data.move;
        if (data.best) return data.best;
        if (data.bestmove) return data.bestmove;
        if (data.pv && Array.isArray(data.pv) && data.pv.length) return data.pv[0];
        // some endpoints might return SAN; but we'll prefer UCI/long algebraic if provided
      }
    } catch (err) {
      // network error, try next
      continue;
    }
  }
  return null;
}

function chooseLegalMoveFallback() {
  // simple fallback: choose a random legal move (not great but keeps playability)
  const moves = game.moves();
  if (moves.length === 0) return null;
  const san = moves[Math.floor(Math.random() * moves.length)];
  const moveObj = game.move(san);
  const last = moveObj ? (moveObj.from + moveObj.to) : null;
  // we need to undo the move because we just wanted the best move string; chess.js changed game
  if (moveObj) game.undo();
  return last; // returns UCI-like "e7e5" if available (from+to), or null
}

async function engineMove() {
  if (engineThinking || game.game_over()) return;
  engineThinking = true;
  try {
    const fen = game.fen();
    // try remote engine
    let engineMove = await getEngineMoveFromAPI(fen);

    if (!engineMove) {
      // fallback to random legal move (using chess.js)
      const fallback = chooseLegalMoveFallback();
      engineMove = fallback;
    }

    if (!engineMove) {
      engineThinking = false;
      return;
    }

    // engineMove might be like "e7e5" or "e7e8q" or SAN (rare). Try to apply robustly:
    // prefer UCI (from+to). If it's SAN, try game.move(san)
    let moveApplied = null;
    // if engineMove includes promotion (4 or 5 chars), split
    if (/^[a-h][1-8][a-h][1-8][qrbn]?$/.test(engineMove)) {
      const from = engineMove.slice(0,2);
      const to = engineMove.slice(2,4);
      const promotion = engineMove.length === 5 ? engineMove[4] : undefined;
      moveApplied = game.move({ from, to, promotion });
    } else {
      // try SAN
      moveApplied = game.move(engineMove);
    }

    // if still null, as last effort, pick a legal move (this shouldn't normally happen)
    if (!moveApplied) {
      const fallback = chooseLegalMoveFallback();
      if (fallback) {
        const from = fallback.slice(0,2);
        const to = fallback.slice(2,4);
        game.move({ from, to });
      }
    }

    board.position(game.fen());
    renderMoveList();

    // check for game end
    if (game.game_over()) finishGame();
  } finally {
    engineThinking = false;
  }
}

function finishGame() {
  resignBtn.style.display = 'none';
  const resultText = game.in_checkmate() ? (game.turn() === 'w' ? 'Black wins (checkmate)' : 'White wins (checkmate)') :
    game.in_draw() ? 'Draw' :
    game.in_stalemate() ? 'Draw (stalemate)' :
    game.in_threefold_repetition() ? 'Draw (3-fold)' :
    'Game over';
  resultBanner.style.display = 'block';
  resultBanner.innerText = resultText;
}

/* ===== Initialize board UI but don't start a game until Start pressed ===== */
function initBoardUI() {
  const cfg = {
    draggable: true,
    position: 'start',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd,
    pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
  };
  board = Chessboard('myBoard', cfg);
}

/* ===== Start new game (random color) ===== */
function startNewGame() {
  game = new Chess();
  // randomize color
  playerIsWhite = Math.random() < 0.5;
  // if player is black, engine should start (engine plays white)
  board.orientation(playerIsWhite ? 'white' : 'black');
  board.start();
  renderMoveList();
  resultBanner.style.display = 'none';
  resignBtn.style.display = 'inline-block';
  // if player is black, let engine play the first move
  if (!playerIsWhite) {
    engineMove();
  }
}

/* wire up buttons */
startBtn.addEventListener('click', async () => {
  // Start button becomes "Restart" after starting
  startNewGame();
  startBtn.innerText = 'Restart Game';
  // replace action to restart on next click
  startBtn.onclick = () => { location.reload(); }; // simplest restart behavior
});

resignBtn.addEventListener('click', () => {
  if (!game) return;
  // engine wins on resign
  resultBanner.style.display = 'block';
  resultBanner.innerText = playerIsWhite ? 'You resigned — Black (Avyav Bot) wins' : 'You resigned — White (Avyav Bot) wins';
  resignBtn.style.display = 'none';
});

/* Initialize UI on load so the bot page is ready */
initBoardUI();

/* When user clicks the 'Play Chess with Bot' home-button to go to bot page,
   the openPage('bot') is already wired above and will show this page. We only
   fully start a game when the user presses 'Start Game'. */

/* Optional: if you want to auto-start when visiting the page, call startNewGame() here. */

</script>

<!-- visitor logging script kept as in your base (optional) -->
<script>
fetch('/.netlify/functions/log-visit')
  .then(response => response.json())
  .then(data => console.log('Visitor IP logged:', data.ip))
  .catch(err => console.error('Logging failed:', err));
</script>
</body>
</html>
